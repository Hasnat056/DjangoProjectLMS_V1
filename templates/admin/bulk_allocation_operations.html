<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Add Course Allocations - Namal LMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="https://namal.edu.pk/uploads/logo4980416.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }

        .card-gradient {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #0f766e, #059669);
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(15, 118, 110, 0.2);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #0d5f5a, #047857);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3);
        }

        .form-control {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            background-color: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .sidebar-gradient {
            background: linear-gradient(180deg, #1e293b 0%, #334155 50%, #475569 100%);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .nav-item {
            transition: all 0.2s ease;
            margin: 2px 8px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(2px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #0f766e, #059669);
            box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3);
        }

        .radio-group {
            display: flex;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }

        .radio-option {
            flex: 1;
            position: relative;
        }

        .radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            cursor: pointer;
            z-index: 10;
        }

        .radio-option label {
            display: block;
            padding: 8px 16px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .radio-option input[type="radio"]:checked + label {
            background: white;
            color: #059669;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .checkbox-grid {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            padding: 1rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            margin-bottom: 0.25rem;
        }

        .checkbox-item:hover {
            background-color: #f9fafb;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 0.75rem;
            transform: scale(1.1);
        }

        .selection-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .selection-control-btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .selection-control-btn:hover {
            background: #f3f4f6;
        }

        .preview-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .preview-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .preview-item {
            padding: 0.375rem 0.75rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-72 sidebar-gradient text-white flex-shrink-0 flex flex-col">
            <!-- Header -->
            <div class="p-6 border-b border-white/10">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 rounded-xl bg-white p-2 shadow-lg">
                        <img src="https://namal.edu.pk/uploads/logo4980416.png"
                             alt="Namal University Logo"
                             class="w-full h-full object-contain rounded-lg">
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Namal LMS</h1>
                        <p class="text-xs text-white/70">Administration Panel</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <!-- Dashboard -->
                <div class="nav-item p-3 cursor-pointer" onclick="window.location.href='/admin/dashboard/'">
                    <div class="flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
                        </svg>
                        <span class="font-medium">Dashboard</span>
                    </div>
                </div>

                <!-- Allocations (Active) -->
                <div class="nav-item p-3 cursor-pointer active">
                    <div class="flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="font-medium">Course Allocations</span>
                    </div>
                </div>
            </nav>

            <!-- User Profile -->
            <div class="p-4 border-t border-white/10">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-emerald-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-sm font-bold" id="admin-initials">A</span>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium" id="admin-name">Administrator</p>
                        <p class="text-xs text-white/70" id="admin-role">System Administrator</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-hidden flex flex-col">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="flex items-center space-x-2 text-sm text-gray-500">
                            <span>Admin Panel</span>
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            <span>Course Allocations</span>
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-emerald-600 font-medium">Bulk Add Allocations</span>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 mt-1">Bulk Add Course Allocations</h2>
                        <p class="text-gray-600">Create multiple course allocations efficiently</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="/admin/allocations/create/" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                            </svg>
                            <span>Single Mode</span>
                        </a>
                        <a href="/admin/dashboard/?section=allocations" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            <span>Back to Dashboard</span>
                        </a>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 overflow-y-auto bg-gray-50 p-6">
                <!-- Form Container -->
                <div class="max-w-4xl mx-auto">
                    <!-- Display Messages -->
                    {% if messages %}
                        <div class="mb-6">
                            {% for message in messages %}
                                <div class="p-4 rounded-lg mb-4 {% if message.tags == 'success' %}bg-green-50 border border-green-200 text-green-800{% elif message.tags == 'error' %}bg-red-50 border border-red-200 text-red-800{% else %}bg-blue-50 border border-blue-200 text-blue-800{% endif %}">
                                    {{ message }}
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Form -->
                    <div class="card-gradient rounded-xl p-8">
                        <form method="POST" action="/admin/allocations/bulk-create/" id="bulkAllocationForm">
                            {% csrf_token %}

                            <div class="space-y-8">
                                <!-- Mode Selection -->
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                        <svg class="w-5 h-5 text-emerald-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                        </svg>
                                        Allocation Mode
                                    </h3>

                                    <div class="radio-group">
                                        <div class="radio-option">
                                            <input type="radio" id="mode-faculty-to-course" name="bulk_mode" value="faculty_to_course" checked onchange="switchMode('faculty_to_course')">
                                            <label for="mode-faculty-to-course">Multiple Faculty → Single Course</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="mode-course-to-faculty" name="bulk_mode" value="course_to_faculty" onchange="switchMode('course_to_faculty')">
                                            <label for="mode-course-to-faculty">Multiple Courses → Single Faculty</label>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-500 mt-2">Choose allocation pattern for bulk creation</p>
                                </div>

                                <!-- Common Fields -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Session -->
                                    <div>
                                        <label for="id_session" class="block text-sm font-medium text-gray-700 mb-2">
                                            Academic Session <span class="text-red-500">*</span>
                                        </label>
                                        {{ form.session }}
                                        {% if form.session.help_text %}
                                            <p class="text-xs text-gray-500 mt-1">{{ form.session.help_text }}</p>
                                        {% endif %}
                                        {% if form.session.errors %}
                                            <p class="text-xs text-red-500 mt-1">{{ form.session.errors.0 }}</p>
                                        {% endif %}
                                    </div>

                                    <!-- Status -->
                                    <div>
                                        <label for="id_status" class="block text-sm font-medium text-gray-700 mb-2">
                                            Allocation Status <span class="text-red-500">*</span>
                                        </label>
                                        {{ form.status }}
                                        {% if form.status.errors %}
                                            <p class="text-xs text-red-500 mt-1">{{ form.status.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Mode 1: Multiple Faculty → Single Course -->
                                <div id="faculty-to-course-fields" class="space-y-6">
                                    <h4 class="text-md font-medium text-gray-800 border-b border-gray-200 pb-2">
                                        Assign Multiple Faculty to One Course
                                    </h4>

                                    <!-- Single Course Selection -->
                                    <div>
                                        <label for="id_single_course" class="block text-sm font-medium text-gray-700 mb-2">
                                            Course <span class="text-red-500">*</span>
                                        </label>
                                        {{ form.single_course }}
                                        {% if form.single_course.errors %}
                                            <p class="text-xs text-red-500 mt-1">{{ form.single_course.errors.0 }}</p>
                                        {% endif %}
                                    </div>

                                    <!-- Multiple Faculty Selection -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Select Faculty Members <span class="text-red-500">*</span>
                                        </label>
                                        <div class="selection-controls">
                                            <button type="button" onclick="selectAllFaculty()" class="selection-control-btn">
                                                Select All
                                            </button>
                                            <button type="button" onclick="deselectAllFaculty()" class="selection-control-btn">
                                                Deselect All
                                            </button>
                                            <span id="faculty-count" class="text-sm text-gray-600 ml-auto">0 selected</span>
                                        </div>
                                        <div class="checkbox-grid" id="faculty-grid">
                                            {% for choice in form.multiple_faculty %}
                                                <div class="checkbox-item">
                                                    {{ choice.tag }}
                                                    <label for="{{ choice.id_for_label }}" class="flex-1 cursor-pointer">
                                                        {{ choice.choice_label }}
                                                    </label>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        {% if form.multiple_faculty.errors %}
                                            <p class="text-xs text-red-500 mt-1">{{ form.multiple_faculty.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Mode 2: Multiple Courses → Single Faculty -->
                                <div id="course-to-faculty-fields" class="space-y-6 hidden">
                                    <h4 class="text-md font-medium text-gray-800 border-b border-gray-200 pb-2">
                                        Assign Multiple Courses to One Faculty
                                    </h4>

                                    <!-- Single Faculty Selection -->
                                    <div>
                                        <label for="id_single_faculty" class="block text-sm font-medium text-gray-700 mb-2">
                                            Faculty Member <span class="text-red-500">*</span>
                                        </label>
                                        {{ form.single_faculty }}
                                        {% if form.single_faculty.errors %}
                                            <p class="text-xs text-red-500 mt-1">{{ form.single_faculty.errors.0 }}</p>
                                        {% endif %}
                                    </div>

                                    <!-- Multiple Courses Selection -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Select Courses <span class="text-red-500">*</span>
                                        </label>
                                        <div class="selection-controls">
                                            <button type="button" onclick="selectAllCourses()" class="selection-control-btn">
                                                Select All
                                            </button>
                                            <button type="button" onclick="deselectAllCourses()" class="selection-control-btn">
                                                Deselect All
                                            </button>
                                            <span id="course-count" class="text-sm text-gray-600 ml-auto">0 selected</span>
                                        </div>
                                        <div class="checkbox-grid" id="course-grid">
                                            {% for choice in form.multiple_courses %}
                                                <div class="checkbox-item">
                                                    {{ choice.tag }}
                                                    <label for="{{ choice.id_for_label }}" class="flex-1 cursor-pointer">
                                                        {{ choice.choice_label }}
                                                    </label>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        {% if form.multiple_courses.errors %}
                                            <p class="text-xs text-red-500 mt-1">{{ form.multiple_courses.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Preview Section -->
                                <div class="preview-section">
                                    <h4 class="text-sm font-medium text-gray-700 mb-3">Allocation Preview:</h4>
                                    <div id="allocation-preview" class="text-sm text-gray-500">
                                        Select session and allocation details to see preview
                                    </div>
                                    <div id="preview-list" class="preview-list mt-3 hidden">
                                        <!-- Dynamic preview items will be added here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Buttons -->
                            <div class="flex justify-end space-x-3 mt-8 pt-6 border-t border-gray-200">
                                <a href="/admin/dashboard/?section=allocations" class="px-6 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                                    Cancel
                                </a>
                                <button type="submit" name="action" value="add_another" class="btn-primary text-white px-6 py-2 rounded-lg flex items-center space-x-2">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>Create & Add More</span>
                                </button>
                                <button type="submit" name="action" value="done" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors flex items-center space-x-2">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span>Create & Done</span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Helper Information -->
                    <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Mode Information -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-blue-800 mb-3">Allocation Modes</h4>
                            <div class="space-y-3 text-sm">
                                <div class="flex items-start">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 mr-3">
                                        Faculty → Course
                                    </span>
                                    <span class="text-blue-700">Assign multiple faculty members to teach the same course in the same session</span>
                                </div>
                                <div class="flex items-start">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800 mr-3">
                                        Course → Faculty
                                    </span>
                                    <span class="text-blue-700">Assign multiple courses to be taught by the same faculty member in the same session</span>
                                </div>
                            </div>
                        </div>

                        <!-- Guidelines -->
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-yellow-800 mb-3">Bulk Creation Guidelines</h4>
                            <ul class="text-sm text-yellow-700 space-y-2">
                                <li class="flex items-start">
                                    <svg class="w-4 h-4 text-yellow-600 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>System will check for duplicate allocations automatically</span>
                                </li>
                                <li class="flex items-start">
                                    <svg class="w-4 h-4 text-yellow-600 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>All allocations will be created with the same session and status</span>
                                </li>
                                <li class="flex items-start">
                                    <svg class="w-4 h-4 text-yellow-600 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>Use single mode for specific one-to-one allocations</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        let currentMode = 'faculty_to_course';

        document.addEventListener('DOMContentLoaded', function() {
            loadAdminProfile();
            setupEventListeners();
            updatePreview();
        });

        function switchMode(mode) {
            currentMode = mode;

            const facultyToCourseFields = document.getElementById('faculty-to-course-fields');
            const courseToFacultyFields = document.getElementById('course-to-faculty-fields');

            if (mode === 'faculty_to_course') {
                facultyToCourseFields.classList.remove('hidden');
                courseToFacultyFields.classList.add('hidden');
            } else {
                facultyToCourseFields.classList.add('hidden');
                courseToFacultyFields.classList.remove('hidden');
            }

            updatePreview();
        }

        function setupEventListeners() {
            // Add change listeners for preview updates
            const sessionInput = document.getElementById('id_session');
            const statusSelect = document.getElementById('id_status');
            const singleCourseSelect = document.getElementById('id_single_course');
            const singleFacultySelect = document.getElementById('id_single_faculty');

            if (sessionInput) {
                sessionInput.addEventListener('input', updatePreview);
            }

            if (statusSelect) {
                statusSelect.addEventListener('change', updatePreview);
            }

            if (singleCourseSelect) {
                singleCourseSelect.addEventListener('change', updatePreview);
            }

            if (singleFacultySelect) {
                singleFacultySelect.addEventListener('change', updatePreview);
            }

            // Add listeners for checkbox selections
            document.addEventListener('change', function(e) {
                if (e.target.name === 'multiple_faculty') {
                    updateFacultyCount();
                    updatePreview();
                } else if (e.target.name === 'multiple_courses') {
                    updateCourseCount();
                    updatePreview();
                }
            });
        }

        function selectAllFaculty() {
            const checkboxes = document.querySelectorAll('input[name="multiple_faculty"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateFacultyCount();
            updatePreview();
        }

        function deselectAllFaculty() {
            const checkboxes = document.querySelectorAll('input[name="multiple_faculty"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateFacultyCount();
            updatePreview();
        }

        function selectAllCourses() {
            const checkboxes = document.querySelectorAll('input[name="multiple_courses"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateCourseCount();
            updatePreview();
        }

        function deselectAllCourses() {
            const checkboxes = document.querySelectorAll('input[name="multiple_courses"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateCourseCount();
            updatePreview();
        }

        function updateFacultyCount() {
            const checkedBoxes = document.querySelectorAll('input[name="multiple_faculty"]:checked');
            document.getElementById('faculty-count').textContent = `${checkedBoxes.length} selected`;
        }

        function updateCourseCount() {
            const checkedBoxes = document.querySelectorAll('input[name="multiple_courses"]:checked');
            document.getElementById('course-count').textContent = `${checkedBoxes.length} selected`;
        }

        function updatePreview() {
            const previewElement = document.getElementById('allocation-preview');
            const previewList = document.getElementById('preview-list');
            const session = document.getElementById('id_session').value;
            const status = document.getElementById('id_status').value;

            if (!session) {
                previewElement.textContent = 'Enter session to see preview';
                previewList.classList.add('hidden');
                return;
            }

            let previewItems = [];

            if (currentMode === 'faculty_to_course') {
                const courseSelect = document.getElementById('id_single_course');
                const courseName = courseSelect.options[courseSelect.selectedIndex]?.text || '';
                const checkedFaculty = document.querySelectorAll('input[name="multiple_faculty"]:checked');

                if (courseName && courseName !== 'Select Course' && checkedFaculty.length > 0) {
                    previewElement.textContent = `Creating ${checkedFaculty.length} allocation(s) for ${courseName} in ${session} (Status: ${status})`;

                    checkedFaculty.forEach(checkbox => {
                        const label = checkbox.parentElement.querySelector('label').textContent.trim();
                        previewItems.push(`${label} → ${courseName}`);
                    });
                } else {
                    previewElement.textContent = 'Select course and faculty members to see preview';
                }
            } else {
                const facultySelect = document.getElementById('id_single_faculty');
                const facultyName = facultySelect.options[facultySelect.selectedIndex]?.text || '';
                const checkedCourses = document.querySelectorAll('input[name="multiple_courses"]:checked');

                if (facultyName && facultyName !== 'Select Faculty Member' && checkedCourses.length > 0) {
                    previewElement.textContent = `Creating ${checkedCourses.length} allocation(s) for ${facultyName} in ${session} (Status: ${status})`;

                    checkedCourses.forEach(checkbox => {
                        const label = checkbox.parentElement.querySelector('label').textContent.trim();
                        previewItems.push(`${facultyName} → ${label}`);
                    });
                } else {
                    previewElement.textContent = 'Select faculty member and courses to see preview';
                }
            }

            // Update preview list
            if (previewItems.length > 0) {
                previewList.innerHTML = '';
                previewItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.textContent = item;
                    previewList.appendChild(div);
                });
                previewList.classList.remove('hidden');
            } else {
                previewList.classList.add('hidden');
            }
        }

        // Form validation
        document.getElementById('bulkAllocationForm').addEventListener('submit', function(e) {
            let hasErrors = false;
            const session = document.getElementById('id_session').value;
            const status = document.getElementById('id_status').value;

            if (!session.trim()) {
                hasErrors = true;
                alert('Please enter an academic session.');
                return false;
            }

            if (!status) {
                hasErrors = true;
                alert('Please select an allocation status.');
                return false;
            }

            if (currentMode === 'faculty_to_course') {
                const course = document.getElementById('id_single_course').value;
                const checkedFaculty = document.querySelectorAll('input[name="multiple_faculty"]:checked');

                if (!course) {
                    hasErrors = true;
                    alert('Please select a course.');
                    return false;
                }

                if (checkedFaculty.length === 0) {
                    hasErrors = true;
                    alert('Please select at least one faculty member.');
                    return false;
                }
            } else {
                const faculty = document.getElementById('id_single_faculty').value;
                const checkedCourses = document.querySelectorAll('input[name="multiple_courses"]:checked');

                if (!faculty) {
                    hasErrors = true;
                    alert('Please select a faculty member.');
                    return false;
                }

                if (checkedCourses.length === 0) {
                    hasErrors = true;
                    alert('Please select at least one course.');
                    return false;
                }
            }

            if (!hasErrors) {
                // Show loading state
                const submitButtons = document.querySelectorAll('button[type="submit"]');
                const clickedButton = e.submitter;

                submitButtons.forEach(btn => {
                    btn.disabled = true;
                    if (btn === clickedButton) {
                        const span = btn.querySelector('span');
                        const originalText = span.textContent;
                        span.textContent = 'Processing...';
                        btn.dataset.originalText = originalText;
                    }
                });
            }
        });

        async function loadAdminProfile() {
            try {
                const response = await fetch('/admin/api/user-profile/');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('admin-initials').textContent = data.initials || 'A';
                    document.getElementById('admin-name').textContent = data.name || 'Administrator';
                    document.getElementById('admin-role').textContent = data.role || 'System Administrator';
                }
            } catch (error) {
                console.error('Error loading admin profile:', error);
            }
        }

        // Initialize counts on page load
        updateFacultyCount();
        updateCourseCount();
    </script>
</body>
</html>