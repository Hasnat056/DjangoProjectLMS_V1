<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Performance Report - Namal University</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="icon" type="image/png" href="https://namal.edu.pk/uploads/logo4980416.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }

        .sidebar-gradient {
            background: linear-gradient(180deg, #1e293b 0%, #334155 50%, #475569 100%);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .nav-item {
            transition: all 0.2s ease;
            margin: 2px 8px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(2px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #0f766e, #059669);
            box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3);
        }

        .card-gradient {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #0f766e, #059669);
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(15, 118, 110, 0.2);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #0d5f5a, #047857);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3);
        }

        .faculty-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .faculty-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left-color: #059669;
        }

        .performance-excellent { border-left-color: #10b981 !important; }
        .performance-good { border-left-color: #3b82f6 !important; }
        .performance-average { border-left-color: #f59e0b !important; }
        .performance-poor { border-left-color: #ef4444 !important; }
        .performance-no-data { border-left-color: #6b7280 !important; }

        .sort-btn {
            transition: all 0.2s ease;
        }

        .sort-btn:hover {
            background-color: #f3f4f6;
        }

        .sort-btn.active {
            background-color: #059669;
            color: white;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .export-dropdown {
            transform: translateY(-10px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .export-dropdown.show {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        @media print {
            .print-hidden {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        .print-only {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-72 sidebar-gradient text-white flex-shrink-0 flex flex-col print-hidden">
            <!-- Header -->
            <div class="p-6 border-b border-white/10">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 rounded-xl bg-white p-2 shadow-lg">
                        <img src="https://namal.edu.pk/uploads/logo4980416.png"
                             alt="Namal University Logo"
                             class="w-full h-full object-contain rounded-lg">
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Namal LMS</h1>
                        <p class="text-xs text-white/70">Faculty Analytics</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <div class="nav-item p-3 cursor-pointer" onclick="window.location.href='/admin/dashboard/'">
                    <div class="flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
                        </svg>
                        <span class="font-medium">Dashboard</span>
                    </div>
                </div>
                <div class="nav-item p-3 cursor-pointer" onclick="window.location.href='/admin/dashboard/?section=reports'">
                    <div class="flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 2V6a1 1 0 112 0v1h2a1 1 0 110 2H9a1 1 0 110-2z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="font-medium">Reports</span>
                    </div>
                </div>
                <div class="nav-item p-3 cursor-pointer active">
                    <div class="flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                        </svg>
                        <span class="font-medium">Faculty Performance</span>
                    </div>
                </div>
            </nav>

            <!-- User Profile -->
            <div class="p-4 border-t border-white/10">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-emerald-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-sm font-bold">AD</span>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium">Administrator</p>
                        <p class="text-xs text-white/70">System Admin</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-hidden flex flex-col">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4 print-hidden">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="flex items-center space-x-2 text-sm text-gray-500">
                            <span>Admin Panel</span>
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            <a href="/admin/dashboard/?section=reports" class="hover:text-emerald-600">Reports</a>
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-emerald-600 font-medium">Faculty Performance</span>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 mt-1">Faculty Performance Report</h2>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Sort Options -->
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">Sort by:</span>
                            <select id="sort-select" onchange="applySorting()" class="bg-white border border-gray-300 rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                <option value="avg_student_gpa" {% if sort_by == 'avg_student_gpa' %}selected{% endif %}>Student GPA</option>
                                <option value="allocation_count" {% if sort_by == 'allocation_count' %}selected{% endif %}>Course Load</option>
                                <option value="total_students" {% if sort_by == 'total_students' %}selected{% endif %}>Total Students</option>
                            </select>
                            <button onclick="toggleSortOrder()" class="sort-btn px-3 py-1 rounded-lg text-sm border border-gray-300 {% if order == 'desc' %}active{% endif %}">
                                {% if order == 'desc' %}↓{% else %}↑{% endif %}
                            </button>
                        </div>

                        <!-- Export Dropdown -->
                        <div class="relative">
                            <button onclick="toggleExportDropdown()" class="btn-primary text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                                <span>Export Report</span>
                            </button>
                            <div id="export-dropdown" class="export-dropdown absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg z-50 border border-gray-200">
                                <div class="py-1">
                                    <button onclick="exportToPDF()" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <svg class="w-4 h-4 mr-3 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                                        </svg>
                                        Export as PDF
                                    </button>
                                    <button onclick="exportToExcel()" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <svg class="w-4 h-4 mr-3 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                                        </svg>
                                        Export as Excel
                                    </button>
                                    <button onclick="printReport()" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <svg class="w-4 h-4 mr-3 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd"></path>
                                        </svg>
                                        Print Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 overflow-y-auto bg-gray-50 p-6" id="report-content">
                <div class="max-w-7xl mx-auto space-y-6">

                    <!-- Report Header for Print -->
                    <div class="text-center mb-8 print-only">
                        <img src="https://namal.edu.pk/uploads/logo4980416.png" alt="Namal University" class="h-16 mx-auto mb-4">
                        <h1 class="text-3xl font-bold text-gray-900">Faculty Performance Report</h1>
                        <p class="text-sm text-gray-500 mt-1" id="print-date">Generated on: December 15, 2024</p>
                    </div>

                    <!-- Overview Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card relative overflow-hidden bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl p-6 text-white shadow-xl">
                            <div class="absolute top-0 right-0 -mt-4 -mr-4 w-20 h-20 bg-white/10 rounded-full"></div>
                            <div class="relative z-10">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="p-3 bg-white/20 rounded-lg backdrop-blur-sm">
                                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                                        </svg>
                                    </div>
                                    <span class="text-blue-200 text-sm font-medium">Total</span>
                                </div>
                                <div class="text-3xl font-bold mb-2" id="total-faculty">{{ faculty_performance|length }}</div>
                                <div class="text-blue-200 text-sm">Faculty Members</div>
                            </div>
                        </div>

                        <div class="stat-card relative overflow-hidden bg-gradient-to-br from-emerald-500 to-emerald-700 rounded-2xl p-6 text-white shadow-xl">
                            <div class="absolute top-0 right-0 -mt-4 -mr-4 w-20 h-20 bg-white/10 rounded-full"></div>
                            <div class="relative z-10">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="p-3 bg-white/20 rounded-lg backdrop-blur-sm">
                                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"></path>
                                        </svg>
                                    </div>
                                    <span class="text-emerald-200 text-sm font-medium">Average</span>
                                </div>
                                <div class="text-3xl font-bold mb-2" id="avg-gpa">3.42</div>
                                <div class="text-emerald-200 text-sm">Student GPA</div>
                            </div>
                        </div>

                        <div class="stat-card relative overflow-hidden bg-gradient-to-br from-purple-500 to-purple-700 rounded-2xl p-6 text-white shadow-xl">
                            <div class="absolute top-0 right-0 -mt-4 -mr-4 w-20 h-20 bg-white/10 rounded-full"></div>
                            <div class="relative z-10">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="p-3 bg-white/20 rounded-lg backdrop-blur-sm">
                                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                                        </svg>
                                    </div>
                                    <span class="text-purple-200 text-sm font-medium">Total</span>
                                </div>
                                <div class="text-3xl font-bold mb-2" id="total-students">0</div>
                                <div class="text-purple-200 text-sm">Students Taught</div>
                            </div>
                        </div>

                        <div class="stat-card relative overflow-hidden bg-gradient-to-br from-orange-500 to-orange-700 rounded-2xl p-6 text-white shadow-xl">
                            <div class="absolute top-0 right-0 -mt-4 -mr-4 w-20 h-20 bg-white/10 rounded-full"></div>
                            <div class="relative z-10">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="p-3 bg-white/20 rounded-lg backdrop-blur-sm">
                                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"></path>
                                            <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"></path>
                                        </svg>
                                    </div>
                                    <span class="text-orange-200 text-sm font-medium">Active</span>
                                </div>
                                <div class="text-3xl font-bold mb-2" id="total-allocations">0</div>
                                <div class="text-orange-200 text-sm">Course Allocations</div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- GPA Distribution Chart -->
                        <div class="card-gradient rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                                <svg class="w-5 h-5 text-emerald-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"></path>
                                    <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"></path>
                                </svg>
                                Faculty Performance Distribution
                            </h3>
                            <div class="chart-container">
                                <canvas id="performanceChart"></canvas>
                            </div>
                        </div>

                        <!-- Workload Distribution Chart -->
                        <div class="card-gradient rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                                <svg class="w-5 h-5 text-emerald-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
                                </svg>
                                Course Load Distribution
                            </h3>
                            <div class="chart-container">
                                <canvas id="workloadChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Faculty Performance Cards -->
                    <div class="card-gradient rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                            <svg class="w-5 h-5 text-emerald-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                            </svg>
                            Faculty Performance Overview
                        </h3>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="faculty-cards-container">
                            {% for faculty_perf in faculty_performance %}
                            <div class="faculty-card card-gradient rounded-lg p-6 {% if faculty_perf.performance_level == 'Excellent' %}performance-excellent{% elif faculty_perf.performance_level == 'Good' %}performance-good{% elif faculty_perf.performance_level == 'Average' %}performance-average{% elif faculty_perf.performance_level == 'Needs Improvement' %}performance-poor{% else %}performance-no-data{% endif %}">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-full flex items-center justify-center">
                                            <span class="text-white font-bold text-lg">
                                                {{ faculty_perf.faculty_initials|default:'FA' }}
                                            </span>
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-gray-900">
                                                {{ faculty_perf.faculty_name|default:'Faculty Name' }}
                                            </h4>
                                            <p class="text-sm text-gray-600">{{ faculty_perf.department_name|default:'Department' }}</p>
                                            <p class="text-xs text-gray-500">ID: {{ faculty_perf.faculty_id|default:'N/A' }}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        {% if faculty_perf.performance_level == 'Excellent' %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Excellent</span>
                                        {% elif faculty_perf.performance_level == 'Good' %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Good</span>
                                        {% elif faculty_perf.performance_level == 'Average' %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Average</span>
                                        {% elif faculty_perf.performance_level == 'Needs Improvement' %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Needs Improvement</span>
                                        {% else %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">No Data</span>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="grid grid-cols-3 gap-4 mb-4">
                                    <div class="text-center p-3 bg-blue-50 rounded-lg">
                                        <div class="text-2xl font-bold text-blue-600">{{ faculty_perf.allocation_count }}</div>
                                        <div class="text-xs text-blue-600 font-medium">Course Load</div>
                                    </div>
                                    <div class="text-center p-3 bg-purple-50 rounded-lg">
                                        <div class="text-2xl font-bold text-purple-600">{{ faculty_perf.total_students }}</div>
                                        <div class="text-xs text-purple-600 font-medium">Students</div>
                                    </div>
                                    <div class="text-center p-3 bg-emerald-50 rounded-lg">
                                        <div class="text-2xl font-bold text-emerald-600">
                                            {% if faculty_perf.avg_student_gpa and faculty_perf.avg_student_gpa != 'N/A' %}
                                                {{ faculty_perf.avg_student_gpa }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </div>
                                        <div class="text-xs text-emerald-600 font-medium">Avg GPA</div>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"></path>
                                        </svg>
                                        <span class="text-sm text-gray-600">
                                            {% if faculty_perf.allocation_count > 0 %}
                                                Teaching {{ faculty_perf.allocation_count }} course{{ faculty_perf.allocation_count|pluralize }}
                                            {% else %}
                                                No current courses
                                            {% endif %}
                                        </span>
                                    </div>
                                    <a href="/admin/faculty/{{ faculty_perf.faculty_id }}/" class="text-emerald-600 hover:text-emerald-700 text-sm font-medium">
                                        View Details →
                                    </a>
                                </div>
                            </div>
                            {% empty %}
                            <div class="col-span-2 text-center py-12">
                                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                                </svg>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No Faculty Data</h3>
                                <p class="text-gray-600">No faculty performance data is available at this time.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Performance Summary Table -->
                    <div class="card-gradient rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                            <svg class="w-5 h-5 text-emerald-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
                            </svg>
                            Performance Summary Table
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full" id="performance-table">
                                <thead>
                                    <tr class="border-b-2 border-gray-200">
                                        <th class="text-left py-4 px-6 text-sm font-bold text-gray-700 uppercase tracking-wider">Faculty</th>
                                        <th class="text-center py-4 px-4 text-sm font-bold text-blue-700 uppercase tracking-wider">Department</th>
                                        <th class="text-center py-4 px-4 text-sm font-bold text-purple-700 uppercase tracking-wider">Course Load</th>
                                        <th class="text-center py-4 px-4 text-sm font-bold text-orange-700 uppercase tracking-wider">Students</th>
                                        <th class="text-center py-4 px-4 text-sm font-bold text-green-700 uppercase tracking-wider">Avg GPA</th>
                                        <th class="text-center py-4 px-4 text-sm font-bold text-gray-700 uppercase tracking-wider">Performance</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    {% for faculty_perf in faculty_performance %}
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="py-4 px-6">
                                            <div class="flex items-center space-x-3">
                                                <div class="w-8 h-8 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-full flex items-center justify-center">
                                                    <span class="text-white font-bold text-xs">
                                                        {{ faculty_perf.faculty_initials|default:'FA' }}
                                                    </span>
                                                </div>
                                                <div>
                                                    <div class="font-medium text-gray-900">
                                                        {{ faculty_perf.faculty.employeeid.personid.fname }} {{ faculty_perf.faculty.employeeid.personid.lname }}
                                                    </div>
                                                    <div class="text-xs text-gray-500">{{ faculty_perf.faculty.employeeid.personid.personid }}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="py-4 px-4 text-center">
                                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                                                {{ faculty_perf.faculty.departmentid.departmentname }}
                                            </span>
                                        </td>
                                        <td class="py-4 px-4 text-center">
                                            <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium">
                                                {{ faculty_perf.allocation_count }}
                                            </span>
                                        </td>
                                        <td class="py-4 px-4 text-center">
                                            <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-medium">
                                                {{ faculty_perf.total_students }}
                                            </span>
                                        </td>
                                        <td class="py-4 px-4 text-center">
                                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                                                {% if faculty_perf.avg_student_gpa != 'N/A' %}
                                                    {{ faculty_perf.avg_student_gpa }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td class="py-4 px-4 text-center">
                                            {% if faculty_perf.avg_student_gpa != 'N/A' %}
                                                {% if faculty_perf.avg_student_gpa >= 3.5 %}
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Excellent</span>
                                                {% elif faculty_perf.avg_student_gpa >= 3.0 %}
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Good</span>
                                                {% elif faculty_perf.avg_student_gpa >= 2.5 %}
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Average</span>
                                                {% else %}
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Needs Improvement</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">No Data</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Insights and Recommendations -->
                    <div class="card-gradient rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                            <svg class="w-5 h-5 text-emerald-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path>
                            </svg>
                            Performance Insights & Recommendations
                        </h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg">
                                    <h4 class="font-semibold text-gray-900 mb-2">Performance Metrics</h4>
                                    <div class="space-y-2">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-gray-600">High Performers (GPA ≥ 3.5)</span>
                                            <span class="font-medium text-gray-900" id="high-performers">0</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-gray-600">Average Performers (2.5-3.5)</span>
                                            <span class="font-medium text-gray-900" id="avg-performers">0</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-gray-600">Need Support (< 2.5)</span>
                                            <span class="font-medium text-gray-900" id="low-performers">0</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg">
                                    <h4 class="font-semibold text-gray-900 mb-2">Workload Analysis</h4>
                                    <div class="space-y-2">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-gray-600">High Workload (≥ 4 courses)</span>
                                            <span class="font-medium text-green-600" id="high-workload">0</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-gray-600">Balanced (2-3 courses)</span>
                                            <span class="font-medium text-green-600" id="balanced-workload">0</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-gray-600">Light Load (< 2 courses)</span>
                                            <span class="font-medium text-green-600" id="light-workload">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div class="p-4 bg-gradient-to-r from-amber-50 to-yellow-50 rounded-lg">
                                    <h4 class="font-semibold text-gray-900 mb-2">Recommendations</h4>
                                    <ul class="text-sm text-gray-600 space-y-1" id="recommendations">
                                        <li>• Loading recommendations...</li>
                                    </ul>
                                </div>
                                <div class="p-4 bg-gradient-to-r from-purple-50 to-violet-50 rounded-lg">
                                    <h4 class="font-semibold text-gray-900 mb-2">Action Items</h4>
                                    <div class="space-y-2" id="action-items">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-2 h-2 bg-amber-400 rounded-full"></div>
                                            <span class="text-sm text-gray-600">Loading action items...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Django template data integration - Fixed for actual context structure
        const facultyData = [
            {% for faculty_perf in faculty_performance %}
            {
                name: "{{ faculty_perf.faculty_name|default:'N/A' }}",
                initials: "{{ faculty_perf.faculty_initials|default:'FA' }}",
                department: "{{ faculty_perf.department_name|default:'N/A' }}",
                courses: {{ faculty_perf.allocation_count }},
                students: {{ faculty_perf.total_students }},
                avgGpa: {% if faculty_perf.avg_student_gpa and faculty_perf.avg_student_gpa != 'N/A' %}{{ faculty_perf.avg_student_gpa }}{% else %}null{% endif %},
                performance: "{{ faculty_perf.performance_level|default:'No Data' }}",
                workload: "{{ faculty_perf.workload_level|default:'Light' }}",
                facultyId: "{{ faculty_perf.faculty_id|default:'N/A' }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        // Context statistics
        const contextStats = {
            totalFaculty: {{ total_faculty|default:0 }},
            totalStudents: {{ total_students|default:0 }},
            totalAllocations: {{ total_allocations|default:0 }},
            overallAvgGpa: {% if overall_avg_gpa %}{{ overall_avg_gpa }}{% else %}null{% endif %}
        };

        // Initialize the report
        document.addEventListener('DOMContentLoaded', function() {
            loadFacultyData();
            initializeCharts();
            generateInsights();
            updatePrintInfo();
            loadAdminProfile();
        });

        function loadFacultyData() {
            // Use context statistics if available, otherwise calculate from facultyData
            const totalFaculty = contextStats.totalFaculty || facultyData.length;
            const totalStudents = contextStats.totalStudents || facultyData.reduce((sum, f) => sum + f.students, 0);
            const totalAllocations = contextStats.totalAllocations || facultyData.reduce((sum, f) => sum + f.courses, 0);
            const avgGpa = contextStats.overallAvgGpa || calculateAvgGpa();

            document.getElementById('total-faculty').textContent = totalFaculty;
            document.getElementById('total-students').textContent = totalStudents.toLocaleString();
            document.getElementById('total-allocations').textContent = totalAllocations;
            document.getElementById('avg-gpa').textContent = avgGpa !== null ? avgGpa : 'N/A';
        }

        function calculateAvgGpa() {
            const facultyWithGpa = facultyData.filter(f => f.avgGpa !== null);
            return facultyWithGpa.length > 0 ?
                (facultyWithGpa.reduce((sum, f) => sum + f.avgGpa, 0) / facultyWithGpa.length).toFixed(2) : null;
        }

        function initializeCharts() {
            // Performance Distribution Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');

            const performanceCounts = {
                'Excellent': facultyData.filter(f => f.performance === 'Excellent').length,
                'Good': facultyData.filter(f => f.performance === 'Good').length,
                'Average': facultyData.filter(f => f.performance === 'Average').length,
                'Poor': facultyData.filter(f => f.performance === 'Poor').length,
                'No Data': facultyData.filter(f => f.performance === 'No Data').length
            };

            new Chart(performanceCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(performanceCounts),
                    datasets: [{
                        data: Object.values(performanceCounts),
                        backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#6B7280'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 10
                            }
                        }
                    }
                }
            });

            // Workload Distribution Chart
            const workloadCtx = document.getElementById('workloadChart').getContext('2d');

            new Chart(workloadCtx, {
                type: 'bar',
                data: {
                    labels: facultyData.map(f => f.name.split(' ').slice(-1)[0]),
                    datasets: [{
                        label: 'Course Load',
                        data: facultyData.map(f => f.courses),
                        backgroundColor: '#10B981',
                        borderColor: '#059669',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function generateInsights() {
            // Performance metrics
            const highPerformers = facultyData.filter(f => f.avgGpa >= 3.5).length;
            const avgPerformers = facultyData.filter(f => f.avgGpa >= 2.5 && f.avgGpa < 3.5).length;
            const lowPerformers = facultyData.filter(f => f.avgGpa < 2.5 && f.avgGpa !== null).length;

            document.getElementById('high-performers').textContent = highPerformers;
            document.getElementById('avg-performers').textContent = avgPerformers;
            document.getElementById('low-performers').textContent = lowPerformers;

            // Workload metrics
            const highWorkload = facultyData.filter(f => f.courses >= 4).length;
            const balancedWorkload = facultyData.filter(f => f.courses >= 2 && f.courses < 4).length;
            const lightWorkload = facultyData.filter(f => f.courses < 2).length;

            document.getElementById('high-workload').textContent = highWorkload;
            document.getElementById('balanced-workload').textContent = balancedWorkload;
            document.getElementById('light-workload').textContent = lightWorkload;

            // Generate dynamic recommendations
            const recommendations = [];
            if (lowPerformers > 0) {
                recommendations.push(`Provide additional support for ${lowPerformers} faculty with low student performance`);
            }
            if (highWorkload > balancedWorkload) {
                recommendations.push('Consider redistributing course load to balance faculty workload');
            }
            if (highPerformers > 0) {
                recommendations.push(`Recognize and share best practices from ${highPerformers} high-performing faculty`);
            }
            if (lightWorkload > 0) {
                recommendations.push('Optimize course allocation for faculty with light teaching loads');
            }

            const recommendationsEl = document.getElementById('recommendations');
            recommendationsEl.innerHTML = recommendations.map(rec => `<li>• ${rec}</li>`).join('');

            // Generate action items
            const actionItems = [
                { priority: 'high', text: 'Schedule performance review meetings' },
                { priority: 'medium', text: 'Update course allocation strategy' },
                { priority: 'low', text: 'Plan faculty development workshops' }
            ];

            const actionItemsEl = document.getElementById('action-items');
            actionItemsEl.innerHTML = actionItems.map(item => `
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 bg-${item.priority === 'high' ? 'red' : item.priority === 'medium' ? 'yellow' : 'green'}-400 rounded-full"></div>
                    <span class="text-sm text-gray-600">${item.text}</span>
                </div>
            `).join('');
        }

        function updatePrintInfo() {
            document.getElementById('print-date').textContent = `Generated on: ${new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            })}`;
        }

        // Sorting functionality
        function applySorting() {
            const sortBy = document.getElementById('sort-select').value;
            const order = document.querySelector('.sort-btn.active') ? 'desc' : 'asc';

            const url = new URL(window.location);
            url.searchParams.set('sort', sortBy);
            url.searchParams.set('order', order);
            window.location.href = url.toString();
        }

        function toggleSortOrder() {
            const sortBtn = document.querySelector('.sort-btn');
            const isDesc = sortBtn.classList.contains('active');

            if (isDesc) {
                sortBtn.classList.remove('active');
                sortBtn.textContent = '↑';
            } else {
                sortBtn.classList.add('active');
                sortBtn.textContent = '↓';
            }

            applySorting();
        }

        // Export functionality
        function toggleExportDropdown() {
            const dropdown = document.getElementById('export-dropdown');
            dropdown.classList.toggle('show');
        }

        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('export-dropdown');
            const button = event.target.closest('button');

            if (!button || !button.onclick || button.onclick.toString().indexOf('toggleExportDropdown') === -1) {
                dropdown.classList.remove('show');
            }
        });

        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            // Add header
            pdf.setFontSize(20);
            pdf.text('Faculty Performance Report', 20, 30);
            pdf.setFontSize(10);
            pdf.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 40);

            // Add statistics
            pdf.setFontSize(12);
            pdf.text('Performance Summary:', 20, 60);
            pdf.setFontSize(10);

            let yPos = 70;
            facultyData.forEach(faculty => {
                if (yPos > 270) {
                    pdf.addPage();
                    yPos = 20;
                }
                pdf.text(`${faculty.name}: ${faculty.courses} courses, ${faculty.students} students, GPA: ${faculty.avgGpa || 'N/A'}`, 20, yPos);
                yPos += 8;
            });

            pdf.save('Faculty_Performance_Report.pdf');
            document.getElementById('export-dropdown').classList.remove('show');
        }

        function exportToExcel() {
            let csvContent = "Faculty Performance Report\n";
            csvContent += `Generated: ${new Date().toLocaleDateString()}\n\n`;
            csvContent += "Faculty Name,Department,Course Load,Students,Average GPA,Performance\n";

            facultyData.forEach(faculty => {
                csvContent += `"${faculty.name}","${faculty.department}",${faculty.courses},${faculty.students},"${faculty.avgGpa || 'N/A'}","${faculty.performance}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Faculty_Performance_Report.csv';
            link.click();

            document.getElementById('export-dropdown').classList.remove('show');
        }

        function printReport() {
            document.querySelectorAll('.print-only').forEach(el => el.style.display = 'block');
            document.querySelectorAll('.print-hidden').forEach(el => el.style.display = 'none');

            window.print();

            setTimeout(() => {
                document.querySelectorAll('.print-only').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.print-hidden').forEach(el => el.style.display = 'block');
            }, 1000);

            document.getElementById('export-dropdown').classList.remove('show');
        }
        async function loadAdminProfile() {
            try {
                const response = await fetch('/admin/api/user-profile/');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('admin-initials').textContent = data.initials || 'A';
                    document.getElementById('admin-name').textContent = data.name || 'Administrator';
                    document.getElementById('admin-role').textContent = data.role || 'System Administrator';
                }
            } catch (error) {
                console.error('Error loading admin profile:', error);
            }
        }
    </script>
</body>
</html>